{% extends "jobs/jobs_base.html" %}
{% load custom_tags %}

{% block extrascript %}
<style type="text/css">
    .list-group-item-text{
        max-height: 300px;
        margin-bottom: 10px;
        overflow-y:scroll;
        -webkit-overflow-scrolling: touch;
    }
</style>
<script type="text/javascript">
    $(document).ready(function() {
        $("#tab-logs").addClass("active")
    });
</script>
{% endblock %}

{% block navigation %}
    <a href="{% url 'home' %}" class="btn btn-default"><i class="glyphicon glyphicon-dashboard"></i></a>
    <a href="{% url 'jobs' %}" class="btn btn-default">Jobs</a>
    <a href="{% url 'jobs-logs' %}" class="btn btn-default">Logs</a>
    <div class="btn btn-default disabled">Detail</div>
{% endblock %}

{% block tabcontent %}
<h4>Job ID: {{ log.job_uuid }}&nbsp;&nbsp;<small>{{ log.job_start_time|date }}</small></h4>
<p>
    <span class="text-info">Type#</span> {{ log.job_type|title }}
    {% if log.job_remarks %}&nbsp;&nbsp;<span class="text-info">Remarks#</span> {{ log.job_remarks }}{% endif %}
    {% if log.job_params_json %}<br/><span class="text-info">Params#</span>
        {% for param, value in log.job_params_json.items %}
            <span class="text-muted">{{ param|title }}: </span>{{ value }}&nbsp;&nbsp;
        {% endfor %}
    {% endif %}
    <span class="pull-right">
        {% if log.job_result %}
            <span class="text-success"><span class="glyphicon glyphicon-ok-circle"></span> Succeed</span>
        {% else %}
            <span class="text-danger"><span class="glyphicon glyphicon-remove-circle"></span> Failed</span>
        {% endif %}
    </span>
</p>
<hr/>
<div class="panel-body">
    <p><span class="glyphicon glyphicon-time" aria-hidden="true"></span><span class="text-info">
        {% if log.job_start_time %}Started at <strong>{{ log.job_start_time|time:"H:i:s" }}</strong>{% endif %}
        {% if log.job_end_time %} and completed at <strong>{{ log.job_end_time|time:"H:i:s" }}</strong>
        &nbsp;&nbsp;<em>({{ log.duration|floatformat:"0" }} seconds)</em>{% endif %}</span>
        {% if log.job_visible_on_url %}
            <span class="pull-right"><a href="{% url 'log-detail' log.job_uuid %}">Copy this link to Share</a>&nbsp;
            <span class="glyphicon glyphicon-share"></span></span>
        {% endif %}
    </p>
    <hr/>
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-md-3">
                {% if log.job_yml_text %}
                    <h4>Job YML <small>(input)</small></h4>
                    <textarea class="form-control" rows="20" readonly>{{ log.job_yml_text }}</textarea>
                {% endif %}
            </div>
            <div class="col-sm-6 col-md-8">
                <div class="list-group">
                    <h4>Job Log <small>(output)</small></h4>
                    {% for task, details in log.job_log_json.items %}
                    <a href="#" class="list-group-item">
                      <h4 class="list-group-item-heading">{{ task }}</h4>
                        {% for datetime, event in details.items|dictsortreversed:0 %}
                            <p class="list-group-item-text">
                                <strong>{{ datetime|truncatechars:22 }}&nbsp;&nbsp;&nbsp;</strong>
                                <span class="text-muted">{{ event }}</span>
                            </p>
                        {% endfor %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% if 'diff' in log.job_output_json %}
        <hr/>
        <div class="col-sm-6 col-md-12">
            <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#diff">Show Diff</button>
            <span class="text-muted pull-right">
                <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                lines start with <strong class="text-success" style="font-size:large">+</strong>
                are new and those start with <strong class="text-danger" style="font-size:large">-</strong> are old.</span>
            <div id="diff" class="collapse">
                <pre>{{ log.job_output_json|get_item:"diff"|linebreaksbr }}</pre>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
